@page "/my-reservations"
@using CRReservation.COMMON.Models
@using CRReservation.COMMON.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IReservationService ReservationService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@attribute [Authorize]

<h3>Moje Rezerwacje</h3>

@if (reservations == null)
{
    <p><em>Ładowanie...</em></p>
}
else if (!reservations.Any())
{
    <p>Brak rezerwacji.</p>
}
else
{
    <div class="row">
        @foreach (var res in reservations)
        {
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@res.ClassRoomName</h5>
                        <h6 class="card-subtitle mb-2 text-muted">@res.StartDateTime.ToString("g") - @res.EndDateTime.ToString("g")</h6>
                        <p class="card-text">
                            Status: <span class="badge @GetStatusBadge(res.Status)">@res.Status</span>
                        </p>
                        @if (res.Status == "oczekujaca")
                        {
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => CancelReservation(res.Id)">Anuluj</button>
                            @* Edit functionality could be added here later, linking to a reservation edit page *@
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private IEnumerable<ReservationDto>? reservations;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                reservations = await ReservationService.GetMyReservationsAsync(userId);
            }
        }
    }

    private async Task CancelReservation(int id)
    {
        if (await ReservationService.DeleteReservationAsync(id))
        {
            // Refresh list
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                reservations = await ReservationService.GetMyReservationsAsync(userId);
            }
        }
    }

    private string GetStatusBadge(string status) => status switch
    {
        "potwierdzona" => "bg-success",
        "oczekujaca" => "bg-warning",
        "odrzucona" => "bg-danger",
        "anulowana" => "bg-secondary",
        _ => "bg-info"
    };
}
